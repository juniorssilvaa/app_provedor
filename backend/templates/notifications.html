{% extends 'base.html' %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
    <!-- Left Column: Form -->
    <div class="lg:col-span-2 space-y-6">
        <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-lg">
            <h2 class="text-xl font-bold text-white mb-2">Enviar notifica√ß√£o push</h2>
            <p class="text-sm text-gray-400 mb-6">Defina conte√∫do, segmenta√ß√£o e agendamento.</p>

            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Template -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Template</label>
                    <div class="flex gap-2 mb-2">
                        <select id="template-select" name="template_id" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors appearance-none">
                            <option value="">Nenhum template selecionado</option>
                            {% for template in templates %}
                            <option value="{{ template.id }}" 
                                    data-title="{{ template.title }}"
                                    data-body="{{ template.body }}"
                                    data-type="{{ template.type }}"
                                    data-image="{{ template.image_url|default:'' }}">
                                {{ template.name }}
                            </option>
                            {% endfor %}
                        </select>
                        <a href="{% url 'notification_template_create' %}" class="bg-green-600 hover:bg-green-700 text-white font-bold px-4 py-3 rounded-lg transition-colors shadow-lg shadow-green-600/20 flex items-center justify-center whitespace-nowrap">
                            <span class="mr-1">+</span> Criar Template
                        </a>
                    </div>
                    {% if templates %}
                    <div class="flex gap-2">
                        <button type="button" id="edit-template-btn" class="text-xs text-gray-400 hover:text-blue-400 transition-colors hidden">
                            ‚úèÔ∏è Editar template
                        </button>
                        <button type="button" id="delete-template-btn" class="text-xs text-red-400 hover:text-red-300 transition-colors hidden">
                            üóëÔ∏è Excluir template
                        </button>
                    </div>
                    {% endif %}
                </div>

                <!-- Title -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">T√≠tulo</label>
                    <input type="text" id="title-input" name="title" placeholder="Ex: Promo√ß√£o rel√¢mpago" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors">
                </div>

                <!-- Message -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Mensagem</label>
                    <textarea id="body-input" name="body" rows="4" placeholder="Conte√∫do da sua notifica√ß√£o" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors resize-none"></textarea>
                </div>

                <!-- Type & Image -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Tipo</label>
                        <select id="type-select" name="type" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors appearance-none">
                            <option value="info">Informativo</option>
                            <option value="promo">Promocional</option>
                            <option value="warning">Aviso</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Imagem (Opcional)</label>
                        <input type="url" id="image-input" name="image_url" placeholder="https://..." class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                </div>

                <!-- Schedule -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Agendar envio</label>
                    <input type="datetime-local" name="scheduled_at" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-gray-500">
                </div>

                <!-- Segmentation -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Segmenta√ß√£o</label>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <button type="button" data-segment="all" class="segment-btn flex flex-col items-center justify-center p-4 rounded-lg border-2 border-blue-500 bg-blue-500/10 text-white transition-all">
                            <span class="font-bold text-sm">Todos os usu√°rios</span>
                            <span class="text-xs text-blue-200 mt-1">Envia para todos os tokens ativos</span>
                        </button>
                        <button type="button" data-segment="active" class="segment-btn flex flex-col items-center justify-center p-4 rounded-lg border border-gray-700 bg-gray-900 text-gray-400 hover:border-gray-600 transition-all">
                            <span class="font-bold text-sm">Somente ativos</span>
                            <span class="text-xs text-gray-500 mt-1">Usu√°rios com status ativo</span>
                        </button>
                        <button type="button" data-segment="inactive" class="segment-btn flex flex-col items-center justify-center p-4 rounded-lg border border-gray-700 bg-gray-900 text-gray-400 hover:border-gray-600 transition-all">
                            <span class="font-bold text-sm">Somente inativos</span>
                            <span class="text-xs text-gray-500 mt-1">Reengaje usu√°rios inativos</span>
                        </button>
                        <button type="button" data-segment="tags" class="segment-btn flex flex-col items-center justify-center p-4 rounded-lg border border-gray-700 bg-gray-900 text-gray-400 hover:border-gray-600 transition-all">
                            <span class="font-bold text-sm">Por tags</span>
                            <span class="text-xs text-gray-500 mt-1">Informe tags separadas por v√≠rgula</span>
                        </button>
                    </div>
                    <button type="button" id="segment-search-btn" class="w-full p-4 rounded-lg border border-gray-700 bg-gray-900 text-gray-400 hover:border-gray-600 transition-all flex items-center justify-center">
                        <span class="font-bold text-sm">Busca</span>
                        <span class="text-xs text-gray-500 ml-2">Filtra por nome, email ou CPF</span>
                    </button>
                    <input type="hidden" name="segment_type" id="segment-type-input" value="all">
                    <input type="hidden" name="segment_tags" id="segment-tags-input">
                    <input type="hidden" name="segment_search" id="segment-search-input">
                </div>

                <!-- Save as Template -->
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="save-as-template" name="save_as_template" class="w-4 h-4 text-blue-600 bg-gray-900 border-gray-700 rounded focus:ring-blue-500">
                    <label for="save-as-template" class="text-sm text-gray-400">Salvar como template</label>
                    <input type="text" id="template-name-input" name="template_name" placeholder="Nome do template" class="flex-1 bg-gray-900 border border-gray-700 rounded-lg px-4 py-2 text-white text-sm focus:outline-none focus:border-blue-500 transition-colors hidden">
                </div>

                <!-- Submit -->
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg transition-colors shadow-lg shadow-blue-600/20">
                    Enviar notifica√ß√£o
                </button>
            </form>
        </div>
    </div>

    <!-- Right Column: Preview & Tips -->
    <div class="space-y-6">
        <!-- Scheduled Notifications -->
        {% if scheduled_notifications %}
        <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-lg">
            <h3 class="text-sm font-bold text-gray-400 uppercase mb-4">Notifica√ß√µes Agendadas</h3>
            <div class="space-y-3 max-h-64 overflow-y-auto">
                {% for scheduled in scheduled_notifications %}
                <div class="bg-gray-900 rounded-lg p-3 border border-gray-700">
                    <div class="flex items-start justify-between mb-2">
                        <h4 class="text-sm font-semibold text-white">{{ scheduled.title }}</h4>
                        <span class="text-xs px-2 py-1 rounded
                            {% if scheduled.status == 'pending' %}bg-yellow-500/20 text-yellow-400
                            {% elif scheduled.status == 'sent' %}bg-green-500/20 text-green-400
                            {% elif scheduled.status == 'failed' %}bg-red-500/20 text-red-400
                            {% else %}bg-gray-500/20 text-gray-400{% endif %}">
                            {{ scheduled.get_status_display }}
                        </span>
                    </div>
                    <p class="text-xs text-gray-400 mb-2 line-clamp-2">{{ scheduled.body }}</p>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>üìÖ {{ scheduled.scheduled_at|date:"d/m/Y H:i" }}</span>
                        {% if scheduled.status == 'sent' %}
                        <span>‚úì {{ scheduled.sent_count }} enviadas</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        <!-- Preview -->
        <div class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-lg flex flex-col items-center">
            <h3 class="text-sm font-bold text-gray-400 uppercase mb-4 w-full">Pr√©-visualiza√ß√£o</h3>
            
            <!-- Phone Mockup -->
            <div class="relative border-gray-900 bg-gray-900 border-[14px] rounded-[2.5rem] h-[550px] w-[280px] shadow-2xl flex-shrink-0">
                <div class="w-[120px] h-[18px] bg-gray-900 top-0 rounded-b-[1rem] left-1/2 -translate-x-1/2 absolute z-20"></div>
                <div class="h-[32px] w-[3px] bg-gray-800 absolute -left-[17px] top-[72px] rounded-l-lg"></div>
                <div class="h-[46px] w-[3px] bg-gray-800 absolute -left-[17px] top-[124px] rounded-l-lg"></div>
                <div class="h-[46px] w-[3px] bg-gray-800 absolute -left-[17px] top-[178px] rounded-l-lg"></div>
                <div class="h-[64px] w-[3px] bg-gray-800 absolute -right-[17px] top-[142px] rounded-r-lg"></div>
                
                <!-- Screen -->
                <div class="rounded-[2rem] overflow-hidden w-full h-full bg-gray-800 relative">
                    <!-- Wallpaper -->
                    <div class="absolute inset-0 bg-gradient-to-b from-blue-900 to-black opacity-80"></div>
                    
                    <!-- Status Bar -->
                    <div class="absolute top-3 w-full px-5 flex justify-between text-[10px] text-white font-medium z-10">
                        <span>9:41</span>
                        <div class="flex space-x-1">
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.73 0 1.33-.6 1.33-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
                        </div>
                    </div>

                    <!-- Notification Area -->
                    <div class="absolute top-14 left-2 right-2 z-20">
                        <!-- Notification Card -->
                        <div id="preview-card" class="bg-white/95 backdrop-blur-md rounded-2xl p-3 shadow-lg transform transition-all duration-300">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center">
                                    <div class="w-5 h-5 bg-blue-600 rounded-md flex items-center justify-center mr-2 shadow-sm">
                                        <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                    </div>
                                    <span class="text-[10px] text-gray-800 font-bold uppercase tracking-wide">APP PROVEDOR</span>
                                </div>
                                <span class="text-[9px] text-gray-500">AGORA</span>
                            </div>
                            <div class="px-0.5">
                                <h4 id="preview-title" class="text-sm font-bold text-gray-900 mb-0.5 leading-tight">T√≠tulo da notifica√ß√£o</h4>
                                <p id="preview-body" class="text-xs text-gray-600 leading-snug">O conte√∫do da sua notifica√ß√£o aparecer√° aqui.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="mt-6 flex justify-center space-x-2 bg-gray-900 p-1 rounded-lg border border-gray-700">
                <button type="button" onclick="setPreviewMode('ios')" id="btn-ios" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-gray-700 text-white shadow-sm">iOS</button>
                <button type="button" onclick="setPreviewMode('android')" id="btn-android" class="px-4 py-1.5 rounded-md text-xs font-bold text-gray-400 hover:text-white transition-all">Android</button>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const titleInput = document.getElementById('title-input');
                const bodyInput = document.getElementById('body-input');
                const typeSelect = document.getElementById('type-select');
                const imageInput = document.getElementById('image-input');
                const templateSelect = document.getElementById('template-select');
                const editTemplateBtn = document.getElementById('edit-template-btn');
                const deleteTemplateBtn = document.getElementById('delete-template-btn');
                const saveAsTemplateCheck = document.getElementById('save-as-template');
                const templateNameInput = document.getElementById('template-name-input');
                const previewTitle = document.getElementById('preview-title');
                const previewBody = document.getElementById('preview-body');
                const previewCard = document.getElementById('preview-card');
                const btnIOS = document.getElementById('btn-ios');
                const btnAndroid = document.getElementById('btn-android');
                const segmentButtons = document.querySelectorAll('.segment-btn');
                const segmentInput = document.getElementById('segment-type-input');
                const segmentTagsInput = document.getElementById('segment-tags-input');
                const segmentSearchInput = document.getElementById('segment-search-input');
                const searchButton = document.getElementById('segment-search-btn');

                // Carregar template selecionado
                templateSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption.value) {
                        titleInput.value = selectedOption.dataset.title || '';
                        bodyInput.value = selectedOption.dataset.body || '';
                        typeSelect.value = selectedOption.dataset.type || 'info';
                        imageInput.value = selectedOption.dataset.image || '';
                        updatePreview();
                        
                        // Mostrar bot√µes de editar/excluir
                        editTemplateBtn.classList.remove('hidden');
                        deleteTemplateBtn.classList.remove('hidden');
                        editTemplateBtn.onclick = function() {
                            window.location.href = '/notifications/templates/' + selectedOption.value + '/edit/';
                        };
                        deleteTemplateBtn.onclick = function() {
                            if (confirm('Tem certeza que deseja excluir este template?')) {
                                window.location.href = '/notifications/templates/' + selectedOption.value + '/delete/';
                            }
                        };
                    } else {
                        // Esconder bot√µes quando nenhum template selecionado
                        editTemplateBtn.classList.add('hidden');
                        deleteTemplateBtn.classList.add('hidden');
                    }
                });

                // Mostrar/ocultar campo de nome do template
                saveAsTemplateCheck.addEventListener('change', function() {
                    if (this.checked) {
                        templateNameInput.classList.remove('hidden');
                        templateNameInput.required = true;
                    } else {
                        templateNameInput.classList.add('hidden');
                        templateNameInput.required = false;
                    }
                });

                function updatePreview() {
                    previewTitle.textContent = titleInput.value || 'T√≠tulo da notifica√ß√£o';
                    previewBody.textContent = bodyInput.value || 'O conte√∫do da sua notifica√ß√£o aparecer√° aqui.';
                }

                if(titleInput) titleInput.addEventListener('input', updatePreview);
                if(bodyInput) bodyInput.addEventListener('input', updatePreview);

                window.setPreviewMode = function(mode) {
                    if (mode === 'ios') {
                        previewCard.className = 'bg-white/95 backdrop-blur-md rounded-2xl p-3 shadow-lg transform transition-all duration-300';
                        btnIOS.className = 'px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-gray-700 text-white shadow-sm';
                        btnAndroid.className = 'px-4 py-1.5 rounded-md text-xs font-bold text-gray-400 hover:text-white transition-all';
                    } else {
                        previewCard.className = 'bg-white rounded-lg p-3 shadow-md border-l-4 border-blue-500 transform transition-all duration-300 mt-2';
                        btnAndroid.className = 'px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-gray-700 text-white shadow-sm';
                        btnIOS.className = 'px-4 py-1.5 rounded-md text-xs font-bold text-gray-400 hover:text-white transition-all';
                    }
                }

                function resetSegmentStyles() {
                    segmentButtons.forEach(function(button) {
                        button.classList.remove('border-2', 'border-blue-500', 'bg-blue-500/10', 'text-white');
                        button.classList.add('border', 'border-gray-700', 'bg-gray-900', 'text-gray-400');
                    });
                }

                segmentButtons.forEach(function(button) {
                    button.addEventListener('click', function() {
                        const mode = button.getAttribute('data-segment') || 'all';
                        segmentInput.value = mode;
                        resetSegmentStyles();
                        button.classList.remove('border', 'border-gray-700', 'bg-gray-900', 'text-gray-400');
                        button.classList.add('border-2', 'border-blue-500', 'bg-blue-500/10', 'text-white');

                        if (mode === 'tags') {
                            const tags = window.prompt('Informe as tags separadas por v√≠rgula:');
                            if (tags !== null) {
                                segmentTagsInput.value = tags;
                            }
                        }
                    });
                });

                if (searchButton) {
                    searchButton.addEventListener('click', function() {
                        const query = window.prompt('Buscar por nome, e-mail ou CPF:');
                        if (query !== null) {
                            segmentSearchInput.value = query;
                            segmentInput.value = 'search';
                        }
                    });
                }
            });
        </script>

        <!-- Best Practices -->
        <div class="bg-blue-900/20 rounded-2xl p-6 border border-blue-900/30">
            <h3 class="text-sm font-bold text-blue-400 mb-4">Melhores pr√°ticas</h3>
            <ul class="space-y-3">
                <li class="flex items-start text-xs text-blue-200/70">
                    <span class="mr-2">‚Ä¢</span>
                    Use t√≠tulos curtos e diretos (at√© 45 caracteres).
                </li>
                <li class="flex items-start text-xs text-blue-200/70">
                    <span class="mr-2">‚Ä¢</span>
                    Combine tags e status para campanhas altamente segmentadas.
                </li>
                <li class="flex items-start text-xs text-blue-200/70">
                    <span class="mr-2">‚Ä¢</span>
                    Utilize agendamentos para evitar hor√°rios de baixa abertura.
                </li>
                <li class="flex items-start text-xs text-blue-200/70">
                    <span class="mr-2">‚Ä¢</span>
                    Envie notifica√ß√µes de cobran√ßa com anteced√™ncia configur√°vel.
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}
