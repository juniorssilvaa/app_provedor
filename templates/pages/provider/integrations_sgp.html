{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-6">Integrações</h2>

    <!-- Card de Integração SGP -->
    <div class="bg-white dark:bg-dark-800 shadow-md rounded-lg overflow-hidden mb-8">
        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
                Configuração do Agente de IA (Pull SGP)
            </h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Configure as credenciais do seu SGP para que o Assistente de IA possa consultar faturas e abrir chamados.
            </p>
        </div>
        <form method="POST" class="px-6 py-6">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="sgp_url" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">URL Base do SGP</label>
                    <input type="url" name="sgp_url" id="sgp_url" placeholder="https://provedor.sgp.tsmx.com.br"
                           value="{{ provider.sgp_url|default:'' }}"
                           class="w-full px-4 py-2 bg-gray-50 dark:bg-dark-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label for="sgp_token" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Token do SGP</label>
                    <input type="text" name="sgp_token" id="sgp_token" placeholder="Token gerado no seu SGP"
                           value="{{ provider.sgp_token|default:'' }}"
                           class="w-full px-4 py-2 bg-gray-50 dark:bg-dark-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
                <div>
                    <label for="sgp_app_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome do App (SGP)</label>
                    <input type="text" name="sgp_app_name" id="sgp_app_name" placeholder="Ex: webchat"
                           value="{{ provider.sgp_app_name|default:'' }}"
                           class="w-full px-4 py-2 bg-gray-50 dark:bg-dark-700 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-all shadow-lg shadow-blue-500/25">
                    Salvar Configurações
                </button>
            </div>
        </form>
    </div>

    <!-- Card de Webhooks (Push SGP) -->
    <div class="bg-white dark:bg-dark-800 shadow-md rounded-lg overflow-hidden">
        <div class="px-6 py-5 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100">
                Integração com SGP (Gateway Genérica)
            </h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Configure webhooks para receber notificações do seu sistema SGP e enviar pushes para seus clientes.
            </p>
        </div>

        <div class="px-6 py-6">
            <!-- Token de Integração -->
            <div>
                <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-2">Seu Token de Integração</h4>
                <div id="token-section" class="flex items-center space-x-4">
                    <div class="flex-grow p-3 bg-gray-100 dark:bg-dark-700 rounded-md">
                        <span id="sgp-token-display" class="text-sm font-mono text-gray-700 dark:text-gray-300"></span>
                    </div>
                    <button id="copy-token-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                        Copiar
                    </button>
                    <button id="generate-token-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out">
                        Gerar Novo Token
                    </button>
                </div>
                <p id="token-created-at" class="text-xs text-gray-500 dark:text-gray-400 mt-2"></p>
            </div>

            <!-- URL do Webhook -->
            <div class="mt-6">
                <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-2">URL do Webhook</h4>
                <div class="flex items-center space-x-4">
                    <input 
                        type="text" 
                        id="webhook-url-display" 
                        class="flex-grow p-3 bg-gray-100 dark:bg-dark-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-mono text-gray-700 dark:text-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="https://webhooks.niochat.com.br/api/webhooks/sgp/"
                    />
                    <button id="copy-webhook-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out whitespace-nowrap">
                        Copiar
                    </button>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                    Você pode editar a URL completa do webhook. Certifique-se de incluir o <code class="bg-gray-200 dark:bg-gray-700 px-1 rounded">provider_token</code> na URL.
                </p>
            </div>

            <!-- Instruções de Uso -->
            <div class="mt-8">
                <h4 class="text-md font-semibold text-gray-800 dark:text-gray-200 mb-2">Como Usar</h4>
                <div class="prose prose-sm dark:prose-invert max-w-none text-gray-600 dark:text-gray-300">
                    <p>Para integrar com o SGP, configure um novo webhook com as seguintes informações:</p>
                    <ol class="list-decimal pl-5 space-y-2">
                        <li><strong>URL:</strong> Use a URL do Webhook fornecida acima. Certifique-se de que ela contenha o seu <code class="font-mono text-sm bg-gray-200 dark:bg-dark-700 px-1 rounded">provider_token</code>.</li>
                        <li><strong>Método HTTP:</strong> POST</li>
                        <li>
                            <strong>Corpo da Requisição (Body):</strong> O corpo da requisição deve ser um JSON contendo o seu token de integração.
                        </li>
                    </ol>
                    <p class="mt-4"><strong>Exemplo de configuração no SGP (JSON):</strong></p>
                    <div class="relative group">
                        <pre id="json-example" class="bg-gray-100 dark:bg-dark-700 p-4 rounded-md text-sm overflow-x-auto"><code class="language-json">{
  "url": "https://webhooks.niochat.com.br/api/webhooks/sgp/?provider_id={{ provider.id }}&provider_token=SEU_TOKEN_AQUI&do_post=true&message_title=Aviso%20Importante",
  "method": "POST",
  "body": {
    "event_type": "new_message",
    "data": {
      "info": "Payload opcional enviado pelo SGP"
    }
  },
  "headers": {
    "Content-Type": "application/json"
  }
}</code></pre>
                        <button onclick="copyExample()" class="absolute top-2 right-2 bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                            Copiar Exemplo
                        </button>
                    </div>
                    <p class="mt-4">
                        O campo <code class="font-mono text-sm bg-gray-200 dark:bg-dark-700 px-1 rounded">provider_token</code> é <strong>obrigatório</strong> e nos ajuda a identificar seu provedor para enviar a notificação push para os clientes corretos.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
  <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-dark-800">
    <div class="mt-3 text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
        <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
      </div>
      <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-gray-100 mt-2">Gerar Novo Token?</h3>
      <div class="mt-2 px-7 py-3">
        <p class="text-sm text-gray-500 dark:text-gray-400">
          Ao gerar um novo token, o token antigo será invalidado imediatamente. Você precisará atualizar a configuração no seu sistema SGP com o novo token para que a integração continue funcionando.
        </p>
      </div>
      <div class="items-center px-4 py-3">
        <button id="confirm-generate-btn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">
          Sim, Gerar Novo Token
        </button>
        <button id="cancel-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const tokenDisplay = document.getElementById('sgp-token-display');
    const tokenCreatedAt = document.getElementById('token-created-at');
    const webhookUrlDisplay = document.getElementById('webhook-url-display');
    const copyTokenBtn = document.getElementById('copy-token-btn');
    const copyWebhookBtn = document.getElementById('copy-webhook-btn');
    const generateTokenBtn = document.getElementById('generate-token-btn');
    const modal = document.getElementById('confirmation-modal');
    const confirmGenerateBtn = document.getElementById('confirm-generate-btn');
    const cancelModalBtn = document.getElementById('cancel-modal-btn');

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white ${isError ? 'bg-red-500' : 'bg-blue-500'}`;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function copyToClipboard(text, type) {
        navigator.clipboard.writeText(text).then(function() {
            showToast(`${type} copiado para a área de transferência!`);
        }, function(err) {
            showToast(`Erro ao copiar ${type}.`, true);
            console.error('Erro ao copiar: ', err);
        });
    }
    
    copyTokenBtn.addEventListener('click', () => {
        const token = tokenDisplay.textContent;
        if (token && token !== 'Nenhum token gerado.') {
            copyToClipboard(token, 'Token');
        }
    });

    copyWebhookBtn.addEventListener('click', () => {
        const url = webhookUrlDisplay.value || webhookUrlDisplay.textContent;
        if (url) {
            copyToClipboard(url, 'URL do Webhook');
        }
    });

    function fetchIntegrationData() {
        fetch("{% url 'get_sgp_integration' %}", {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                tokenDisplay.textContent = data.error;
                tokenDisplay.classList.add('text-red-500');
                return;
            }
            
            if (data.sgp_token) {
                tokenDisplay.textContent = data.sgp_token;
                tokenCreatedAt.textContent = `Gerado em: ${data.sgp_token_created_at}`;
            } else {
                tokenDisplay.textContent = 'Nenhum token gerado.';
                tokenCreatedAt.textContent = '';
            }
            // Atualizar o campo de input com a URL e salvar como última URL salva
            if (webhookUrlDisplay.tagName === 'INPUT') {
                webhookUrlDisplay.value = data.webhook_url;
                lastSavedWebhookUrl = data.webhook_url;
            } else {
                webhookUrlDisplay.textContent = data.webhook_url;
                lastSavedWebhookUrl = data.webhook_url;
            }
        })
        .catch(error => {
            console.error('Erro ao buscar dados de integração:', error);
            showToast('Não foi possível carregar os dados da integração.', true);
        });
    }

    // Salvar URL do webhook quando o usuário editar
    let webhookUrlTimeout;
    let lastSavedWebhookUrl = '';
    
    webhookUrlDisplay.addEventListener('input', () => {
        // Limpa o timeout anterior
        clearTimeout(webhookUrlTimeout);
        
        // Aguarda 1 segundo após o usuário parar de digitar
        webhookUrlTimeout = setTimeout(() => {
            const newUrl = webhookUrlDisplay.value.trim();
            
            // Só salva se a URL mudou
            if (newUrl && newUrl !== lastSavedWebhookUrl) {
                fetch("{% url 'update_webhook_url' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        webhook_url: newUrl
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showToast(data.error, true);
                    } else {
                        showToast('URL do webhook salva com sucesso!');
                        lastSavedWebhookUrl = newUrl;
                    }
                })
                .catch(error => {
                    console.error('Erro ao salvar URL do webhook:', error);
                    showToast('Erro ao salvar URL do webhook.', true);
                });
            }
        }, 1000); // Aguarda 1 segundo após parar de digitar
    });

    // Salvar também quando o campo perder o foco (blur)
    webhookUrlDisplay.addEventListener('blur', () => {
        clearTimeout(webhookUrlTimeout);
        const newUrl = webhookUrlDisplay.value.trim();
        
        if (newUrl && newUrl !== lastSavedWebhookUrl) {
            fetch("{% url 'update_webhook_url' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    webhook_url: newUrl
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, true);
                } else {
                    showToast('URL do webhook salva com sucesso!');
                    lastSavedWebhookUrl = newUrl;
                }
            })
            .catch(error => {
                console.error('Erro ao salvar URL do webhook:', error);
                showToast('Erro ao salvar URL do webhook.', true);
            });
        }
    });

    generateTokenBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
    });

    cancelModalBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
    });

    confirmGenerateBtn.addEventListener('click', () => {
        fetch("{% url 'generate_sgp_token' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showToast(data.error, true);
            } else {
                showToast(data.message);
                // Atualiza o token exibido
                tokenDisplay.textContent = data.sgp_token || data.provider_token;
                tokenDisplay.classList.remove('text-red-500');
                // Atualiza a data de criação
                if (data.sgp_token_created_at) {
                    tokenCreatedAt.textContent = `Gerado em: ${data.sgp_token_created_at}`;
                } else if (data.created_at) {
                    tokenCreatedAt.textContent = `Gerado em: ${data.created_at}`;
                }
                // Recarrega os dados para garantir consistência
                fetchIntegrationData();
            }
            modal.classList.add('hidden');
        })
        .catch(error => {
            console.error('Erro ao gerar novo token:', error);
            showToast('Ocorreu um erro ao gerar o novo token.', true);
            modal.classList.add('hidden');
        });
    });

    window.copyExample = function() {
        const example = document.getElementById('json-example').textContent;
        copyToClipboard(example, 'Exemplo JSON');
    };

    fetchIntegrationData();
});
</script>
{% endblock %}
